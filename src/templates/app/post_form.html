{% extends "base.html" %}

{% block title %}{% if is_edit %}Edit{% else %}New{% endif %} Post | DJGramm{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h1 class="text-xl font-semibold mb-6">
            {% if is_edit %}Edit Post{% else %}Create New Post{% endif %}
        </h1>

        <form method="post" enctype="multipart/form-data" class="space-y-6" id="post-form">
            {% csrf_token %}

            {% if form.errors or image_formset.errors %}
            <div class="bg-red-50 text-red-600 p-4 rounded-lg">
                {% for field in form %}
                    {% for error in field.errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                {% endfor %}
                {% for img_form in image_formset %}
                    {% for error in img_form.errors.values %}
                        <p>{{ error }}</p>
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Images Section -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">Photos</label>

                <!-- Drag & Drop Zone -->
                <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-primary transition cursor-pointer relative" id="dropzone">
                    <input type="file" id="file-input" multiple accept="image/jpeg,image/png,image/webp" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-3 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <p class="text-gray-600 mb-2 pointer-events-none">Drag photos here or click to select</p>
                    <p class="text-gray-400 text-sm pointer-events-none">JPEG, PNG, WebP up to 10MB</p>
                </div>

                <!-- Existing Images Preview (for edit mode) -->
                {% if is_edit and object.images.exists %}
                <div class="mt-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-medium text-gray-700">Current Photos</h3>
                        <span class="text-xs text-gray-400">Drag to reorder â€¢ First photo is cover</span>
                    </div>
                    <div class="grid grid-cols-4 gap-3" id="existing-images">
                        {% for image in object.images.all %}
                        <div class="relative group cursor-move" data-image-id="{{ image.pk }}" draggable="true">
                            {% if forloop.first %}
                            <div class="absolute top-1 left-1 bg-primary text-white text-xs px-2 py-0.5 rounded z-10">Cover</div>
                            {% endif %}
                            <img src="{{ image.image.url }}" alt="Photo {{ forloop.counter }}" class="w-full h-24 object-cover rounded-lg border-2 border-gray-200 hover:border-primary transition">
                            <label class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex items-center justify-center cursor-pointer">
                                <input type="checkbox" name="images-{{ forloop.counter0 }}-DELETE" class="delete-checkbox hidden" data-index="{{ forloop.counter0 }}">
                                <span class="delete-label text-white text-xs font-medium px-2 py-1 bg-red-500 rounded">Delete</span>
                            </label>
                            <div class="absolute top-1 right-1 w-5 h-5 bg-white rounded-full shadow hidden items-center justify-center delete-indicator">
                                <svg class="w-3 h-3 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="absolute bottom-1 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 transition">
                                <svg class="w-4 h-4 text-white drop-shadow" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M7 2a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 2zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 8zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 14zm6-8a2 2 0 1 0-.001-4.001A2 2 0 0 0 13 6zm0 2a2 2 0 1 0 .001 4.001A2 2 0 0 0 13 8zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 13 14z"/>
                                </svg>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- New Images Preview -->
                <div class="mt-4 hidden" id="new-images-section">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">New Photos</h3>
                    <div class="grid grid-cols-4 gap-3" id="new-images-preview"></div>
                </div>

                <!-- Hidden formset for Django -->
                <div class="hidden" id="formset-container">
                    {{ image_formset.management_form }}
                    {% for img_form in image_formset %}
                    <div class="image-form" data-form-index="{{ forloop.counter0 }}">
                        {% if img_form.instance.pk %}
                        <input type="hidden" name="{{ img_form.id.html_name }}" value="{{ img_form.instance.pk }}">
                        <input type="hidden" name="{{ img_form.image.html_name }}" value="{{ img_form.instance.image }}">
                        <input type="checkbox" name="{{ img_form.DELETE.html_name }}" class="existing-delete-cb" data-index="{{ forloop.counter0 }}">
                        {% else %}
                        <input type="file" name="{{ img_form.image.html_name }}" class="new-image-input" accept="image/*">
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Caption -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">Caption</label>
                <textarea name="caption" rows="4" id="caption-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none" placeholder="Write a caption... Use #hashtags to add tags" maxlength="2200">{{ form.caption.value|default:'' }}</textarea>
                <p class="text-gray-400 text-sm mt-1"><span id="char-count">{{ form.caption.value|length|default:0 }}</span>/2200</p>
            </div>

            <!-- Submit -->
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-primary text-white py-3 rounded-lg font-semibold hover:bg-opacity-90 transition">
                    {% if is_edit %}Save Changes{% else %}Share{% endif %}
                </button>
                <a href="{% if is_edit %}{{ object.get_absolute_url }}{% else %}{% url 'feed' %}{% endif %}" class="flex-1 text-center border border-gray-300 py-3 rounded-lg font-semibold hover:bg-gray-50 transition">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-input');
    const newImagesSection = document.getElementById('new-images-section');
    const newImagesPreview = document.getElementById('new-images-preview');
    const formsetContainer = document.getElementById('formset-container');
    const form = document.getElementById('post-form');
    const captionInput = document.getElementById('caption-input');
    const charCount = document.getElementById('char-count');
    const existingImagesContainer = document.getElementById('existing-images');

    let newFiles = [];
    const MAX_FILES = 10;
    const existingImagesCount = existingImagesContainer ? existingImagesContainer.querySelectorAll('[data-image-id]').length : 0;
    const postId = {% if object %}{{ object.pk }}{% else %}null{% endif %};

    // Character counter
    if (captionInput && charCount) {
        captionInput.addEventListener('input', function() {
            charCount.textContent = captionInput.value.length;
        });
    }

    // =========================================================================
    // DRAG & DROP REORDER FOR EXISTING IMAGES
    // =========================================================================
    if (existingImagesContainer) {
        let draggedItem = null;

        existingImagesContainer.querySelectorAll('[data-image-id]').forEach(function(item) {
            item.addEventListener('dragstart', function(e) {
                draggedItem = this;
                this.classList.add('opacity-50');
                e.dataTransfer.effectAllowed = 'move';
            });

            item.addEventListener('dragend', function() {
                this.classList.remove('opacity-50');
                draggedItem = null;
                updateCoverBadge();
                saveImageOrder();
            });

            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });

            item.addEventListener('dragenter', function(e) {
                e.preventDefault();
                if (this !== draggedItem) {
                    this.classList.add('border-primary', 'border-2');
                }
            });

            item.addEventListener('dragleave', function() {
                this.classList.remove('border-primary');
            });

            item.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('border-primary');
                if (this !== draggedItem && draggedItem) {
                    const allItems = Array.from(existingImagesContainer.children);
                    const draggedIndex = allItems.indexOf(draggedItem);
                    const targetIndex = allItems.indexOf(this);

                    if (draggedIndex < targetIndex) {
                        this.parentNode.insertBefore(draggedItem, this.nextSibling);
                    } else {
                        this.parentNode.insertBefore(draggedItem, this);
                    }
                }
            });
        });

        function updateCoverBadge() {
            // Remove all cover badges
            existingImagesContainer.querySelectorAll('.cover-badge').forEach(function(badge) {
                badge.remove();
            });
            // Add cover badge to first image
            const firstImage = existingImagesContainer.querySelector('[data-image-id]');
            if (firstImage) {
                const badge = document.createElement('div');
                badge.className = 'cover-badge absolute top-1 left-1 bg-primary text-white text-xs px-2 py-0.5 rounded z-10';
                badge.textContent = 'Cover';
                firstImage.appendChild(badge);
            }
        }

        function saveImageOrder() {
            if (!postId) return;

            const order = [];
            existingImagesContainer.querySelectorAll('[data-image-id]').forEach(function(item) {
                order.push(parseInt(item.dataset.imageId));
            });

            fetch('/post/' + postId + '/reorder-images/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ order: order })
            }).then(function(response) {
                if (!response.ok) {
                    console.error('Failed to save image order');
                }
            }).catch(function(error) {
                console.error('Error:', error);
            });
        }
    }

    // =========================================================================
    // DELETE CHECKBOX HANDLING
    // =========================================================================
    document.querySelectorAll('.delete-checkbox').forEach(function(checkbox) {
        const container = checkbox.closest('[data-image-id]');
        const label = checkbox.closest('label');
        const indicator = container.querySelector('.delete-indicator');
        const deleteLabel = label.querySelector('.delete-label');

        label.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                container.classList.add('opacity-50');
                container.setAttribute('draggable', 'false');
                indicator.classList.remove('hidden');
                indicator.classList.add('flex');
                deleteLabel.textContent = 'Restore';
                deleteLabel.classList.remove('bg-red-500');
                deleteLabel.classList.add('bg-green-500');
            } else {
                container.classList.remove('opacity-50');
                container.setAttribute('draggable', 'true');
                indicator.classList.add('hidden');
                indicator.classList.remove('flex');
                deleteLabel.textContent = 'Delete';
                deleteLabel.classList.add('bg-red-500');
                deleteLabel.classList.remove('bg-green-500');
            }

            var index = checkbox.dataset.index;
            var hiddenCb = document.querySelector('.existing-delete-cb[data-index="' + index + '"]');
            if (hiddenCb) hiddenCb.checked = checkbox.checked;
        });
    });

    // =========================================================================
    // FILE UPLOAD HANDLING
    // =========================================================================
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function(eventName) {
        dropzone.addEventListener(eventName, function(e) { e.preventDefault(); e.stopPropagation(); }, false);
    });

    ['dragenter', 'dragover'].forEach(function(eventName) {
        dropzone.addEventListener(eventName, function() { dropzone.classList.add('border-primary', 'bg-primary/5'); });
    });

    ['dragleave', 'drop'].forEach(function(eventName) {
        dropzone.addEventListener(eventName, function() { dropzone.classList.remove('border-primary', 'bg-primary/5'); });
    });

    dropzone.addEventListener('drop', function(e) { handleFiles(e.dataTransfer.files); });

    fileInput.addEventListener('change', function(e) {
        handleFiles(e.target.files);
        fileInput.value = '';
    });

    function handleFiles(files) {
        var deletedCount = document.querySelectorAll('.delete-checkbox:checked').length;
        var totalAllowed = MAX_FILES - existingImagesCount + deletedCount;
        var remainingSlots = totalAllowed - newFiles.length;

        if (remainingSlots <= 0) {
            alert('Maximum ' + MAX_FILES + ' images allowed per post.');
            return;
        }

        Array.from(files).slice(0, remainingSlots).forEach(function(file) {
            if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
                alert(file.name + ' is not a valid image type. Please use JPEG, PNG, or WebP.');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                alert(file.name + ' is too large. Maximum size is 10MB.');
                return;
            }
            newFiles.push(file);
            addPreview(file, newFiles.length - 1);
        });
        updateFormset();
    }

    function addPreview(file, index) {
        newImagesSection.classList.remove('hidden');
        var reader = new FileReader();
        reader.onload = function(e) {
            var div = document.createElement('div');
            div.className = 'relative group';
            div.dataset.newIndex = index;
            div.innerHTML = '<img src="' + e.target.result + '" alt="' + file.name + '" class="w-full h-24 object-cover rounded-lg border border-gray-200">' +
                '<button type="button" class="remove-new-image absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex items-center justify-center">' +
                '<span class="text-white text-xs font-medium px-2 py-1 bg-red-500 rounded">Remove</span></button>' +
                '<div class="absolute bottom-0 left-0 right-0 bg-black/60 text-white text-xs p-1 rounded-b-lg truncate">' + file.name + '</div>';
            newImagesPreview.appendChild(div);
            div.querySelector('.remove-new-image').addEventListener('click', function() { removeNewImage(index); });
        };
        reader.readAsDataURL(file);
    }

    function removeNewImage(index) {
        newFiles.splice(index, 1);
        rebuildPreviews();
        updateFormset();
    }

    function rebuildPreviews() {
        newImagesPreview.innerHTML = '';
        if (newFiles.length === 0) {
            newImagesSection.classList.add('hidden');
        } else {
            newFiles.forEach(function(file, index) { addPreview(file, index); });
        }
    }

    function updateFormset() {
        var totalFormsInput = formsetContainer.querySelector('[name$="-TOTAL_FORMS"]');
        var existingCount = formsetContainer.querySelectorAll('.existing-delete-cb').length;
        var totalNeeded = existingCount + newFiles.length;

        if (totalNeeded > parseInt(totalFormsInput.value)) {
            var currentTotal = parseInt(totalFormsInput.value);
            for (var i = currentTotal; i < totalNeeded; i++) {
                var div = document.createElement('div');
                div.className = 'image-form';
                div.dataset.formIndex = i;
                div.innerHTML = '<input type="file" name="images-' + i + '-image" class="new-image-input" accept="image/*">';
                formsetContainer.appendChild(div);
            }
            totalFormsInput.value = totalNeeded;
        }
    }

    // =========================================================================
    // FORM SUBMIT
    // =========================================================================
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        var existingCount = formsetContainer.querySelectorAll('.existing-delete-cb').length;

        newFiles.forEach(function(file, index) {
            var inputIndex = existingCount + index;
            var input = formsetContainer.querySelector('[name="images-' + inputIndex + '-image"]');
            if (!input) {
                var div = document.createElement('div');
                div.className = 'image-form';
                div.innerHTML = '<input type="file" name="images-' + inputIndex + '-image" class="new-image-input" accept="image/*">';
                formsetContainer.appendChild(div);
                input = div.querySelector('input');
            }
            var dt = new DataTransfer();
            dt.items.add(file);
            input.files = dt.files;
        });

        var totalFormsInput = formsetContainer.querySelector('[name$="-TOTAL_FORMS"]');
        totalFormsInput.value = existingCount + newFiles.length;
        form.submit();
    });
})();
</script>
{% endblock %}
