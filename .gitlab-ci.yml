# GitLab CI/CD Pipeline for DJGramm

stages:
  - lint
  - test
  - build

variables:
  POSTGRES_DB: djgramm_test
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  DATABASE_URL: "postgres://postgres:postgres@postgres:5432/djgramm_test"
  SECRET_KEY: "test-secret-key-for-ci"
  DEBUG: "True"
  TESTING: "True"
  ALLOWED_HOSTS: "localhost,127.0.0.1"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  DJANGO_SETTINGS_MODULE: "config.settings"

# Cache pip downloads
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cache/pip
    - .venv/

# Install UV and dependencies
.setup: &setup
  before_script:
    - pip install uv
    - uv venv
    - source .venv/bin/activate || . .venv/Scripts/activate
    - uv sync --frozen

# =============================================================================
# LINT STAGE
# =============================================================================

lint:
  stage: lint
  image: python:3.12-slim
  <<: *setup
  script:
    - uv run ruff check src/ tests/
    - uv run ruff format --check src/ tests/
  allow_failure: false

# =============================================================================
# TEST STAGE
# =============================================================================

test:
  stage: test
  image: python:3.12-slim
  services:
    - postgres:16-alpine
  <<: *setup
  script:
    - cd src
    - uv run python manage.py migrate --noinput
    - cd ..
    - uv run pytest tests/ --cov=app --cov-report=term-missing --cov-report=xml -v
  coverage: '/TOTAL.*\s+(\d+%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week

# Test with Django check
test:django-check:
  stage: test
  image: python:3.12-slim
  services:
    - postgres:16-alpine
  <<: *setup
  script:
    - cd src
    - uv run python manage.py migrate --noinput
    - uv run python manage.py check --deploy
    - uv run python manage.py makemigrations --check --dry-run

# =============================================================================
# BUILD STAGE
# =============================================================================

build:docker:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_DRIVER: overlay2
  before_script:
    - docker info
    - apk add --no-cache git
  script:
    - docker build -t djgramm:${CI_COMMIT_SHORT_SHA} -f docker/Dockerfile .
    - docker tag djgramm:${CI_COMMIT_SHORT_SHA} djgramm:latest
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH == "dev"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Build and push to registry (optional, for deployment)
build:push:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_DRIVER: overlay2
  before_script:
    - apk add --no-cache git
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:${CI_COMMIT_SHORT_SHA} -f docker/Dockerfile .
    - docker push $CI_REGISTRY_IMAGE:${CI_COMMIT_SHORT_SHA}
    - |
      if [ "$CI_COMMIT_BRANCH" == "main" ] || [ "$CI_COMMIT_BRANCH" == "master" ] || [ "$CI_COMMIT_BRANCH" == "develop" ] || [ "$CI_COMMIT_BRANCH" == "dev" ]; then
        docker tag $CI_REGISTRY_IMAGE:${CI_COMMIT_SHORT_SHA} $CI_REGISTRY_IMAGE:latest
        docker push $CI_REGISTRY_IMAGE:latest
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH == "dev"
  when: manual
  allow_failure: true
