---
description: Django rules for DJGramm (single-app monolith)
globs: ["src/**/*.py", "tests/**/*.py", "**/*.html"]
alwaysApply: true
---

# Django Rules - DJGramm

## Project Structure

Single app monolith:
```
src/
├── config/          # settings, urls, wsgi
└── app/             # Single app (scale → apps/)
```

All models in `models.py`. All views in `views.py`. Keep it simple.

---

## 1. Models

### All Models in One File
```python
# src/app/models.py - ALL models here
from django.contrib.auth.models import AbstractUser
from django.db import models
from django.urls import reverse

class User(AbstractUser):
    """Custom user with email auth."""
    email = models.EmailField(unique=True)
    USERNAME_FIELD = "email"
    REQUIRED_FIELDS = ["username"]

class Profile(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    bio = models.TextField(blank=True)
    # ... other fields

class Post(models.Model):
    author = models.ForeignKey(User, on_delete=models.CASCADE, related_name="posts")
    caption = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        ordering = ["-created_at"]
    
    def __str__(self):
        return f"Post #{self.pk} by {self.author.username}"
    
    def get_absolute_url(self):
        return reverse("post_detail", kwargs={"pk": self.pk})

# Tag, PostImage, Like - same file
```

### Model Rules
- Always add `related_name` to FK/M2M
- Always add `__str__` method
- Add `get_absolute_url()` for detail views
- Use `Meta.ordering` for default sort
- Type hints optional but welcome

### Avoid N+1
```python
# ❌ Bad
posts = Post.objects.all()
for p in posts:
    print(p.author.username)  # query per post

# ✅ Good
posts = Post.objects.select_related("author")
posts = Post.objects.prefetch_related("images", "tags")
```

---

## 2. Views

### Class-Based (preferred)
```python
# src/app/views.py
from django.contrib.auth.mixins import LoginRequiredMixin
from django.views.generic import ListView, DetailView, CreateView

class FeedView(ListView):
    model = Post
    template_name = "app/feed.html"
    context_object_name = "posts"
    paginate_by = 12
    
    def get_queryset(self):
        return Post.objects.select_related("author").prefetch_related("images")

class PostCreateView(LoginRequiredMixin, CreateView):
    model = Post
    form_class = PostForm
    template_name = "app/post_form.html"
    
    def form_valid(self, form):
        form.instance.author = self.request.user
        return super().form_valid(form)
```

### Function-Based (for simple actions)
```python
from django.contrib.auth.decorators import login_required
from django.http import JsonResponse
from django.shortcuts import get_object_or_404

@login_required
def toggle_like(request, pk):
    if request.method != "POST":
        return HttpResponseNotAllowed(["POST"])
    
    post = get_object_or_404(Post, pk=pk)
    like, created = Like.objects.get_or_create(user=request.user, post=post)
    
    if not created:
        like.delete()
    
    return JsonResponse({"liked": created, "count": post.likes.count()})
```

---

## 3. URLs

### Single urls.py
```python
# src/app/urls.py
from django.urls import path
from . import views

urlpatterns = [
    path("", views.FeedView.as_view(), name="feed"),
    path("post/new/", views.PostCreateView.as_view(), name="post_create"),
    path("post/<int:pk>/", views.PostDetailView.as_view(), name="post_detail"),
    path("post/<int:pk>/like/", views.toggle_like, name="toggle_like"),
    path("profile/<str:username>/", views.ProfileView.as_view(), name="profile"),
]
```

Use `name=` for all patterns. Reference: `{% url 'post_detail' pk=post.pk %}`

---

## 4. Forms

```python
# src/app/forms.py
from django import forms
from .models import Post, Profile

class PostForm(forms.ModelForm):
    class Meta:
        model = Post
        fields = ["caption"]
        widgets = {
            "caption": forms.Textarea(attrs={"rows": 3, "placeholder": "Caption..."}),
        }

class ProfileForm(forms.ModelForm):
    class Meta:
        model = Profile
        fields = ["full_name", "bio", "avatar"]
```

---

## 5. Templates

### Structure
```
templates/
├── base.html                  # Layout
├── registration/
│   └── login.html
└── app/
    ├── feed.html
    └── post_detail.html
```

### Base Template
```html
<!-- templates/base.html -->
<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}DJGramm{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <nav><!-- navbar --></nav>
    
    <main class="container mx-auto py-4">
        {% if messages %}
            {% for msg in messages %}
                <div class="alert">{{ msg }}</div>
            {% endfor %}
        {% endif %}
        
        {% block content %}{% endblock %}
    </main>
</body>
</html>
```

### Page Template
```html
<!-- templates/app/feed.html -->
{% extends "base.html" %}

{% block content %}
<div class="grid grid-cols-3 gap-4">
    {% for post in posts %}
        <div class="post-card">
            <img src="{{ post.images.first.image.url }}">
            <p>{{ post.caption|truncatewords:20 }}</p>
        </div>
    {% empty %}
        <p>No posts yet</p>
    {% endfor %}
</div>

{% if page_obj.has_other_pages %}
    <!-- pagination -->
{% endif %}
{% endblock %}
```

---

## 6. Services

### Image Processing
```python
# src/app/services.py
from PIL import Image
from io import BytesIO
from django.core.files.base import ContentFile

def generate_thumbnail(image_field, max_size=(300, 300)):
    """Create thumbnail from uploaded image."""
    with Image.open(image_field) as img:
        img.thumbnail(max_size, Image.Resampling.LANCZOS)
        
        if img.mode in ("RGBA", "P"):
            img = img.convert("RGB")
        
        buffer = BytesIO()
        img.save(buffer, format="JPEG", quality=85)
        return ContentFile(buffer.getvalue())

def validate_image(file):
    """Validate image file."""
    MAX_SIZE = 10 * 1024 * 1024  # 10MB
    ALLOWED = {"image/jpeg", "image/png", "image/webp"}
    
    if file.size > MAX_SIZE:
        return False, "Max 10MB"
    if file.content_type not in ALLOWED:
        return False, "JPEG, PNG, WebP only"
    return True, ""
```

---

## 7. Signals

```python
# src/app/signals.py
from django.db.models.signals import post_save
from django.dispatch import receiver
from .models import User, Profile

@receiver(post_save, sender=User)
def create_profile(sender, instance, created, **kwargs):
    if created:
        Profile.objects.create(user=instance)
```

Register in `apps.py`:
```python
class AppConfig(AppConfig):
    name = "app"
    
    def ready(self):
        from . import signals  # noqa
```

---

## 8. Admin

```python
# src/app/admin.py
from django.contrib import admin
from .models import User, Profile, Post, PostImage, Tag, Like

class ProfileInline(admin.StackedInline):
    model = Profile

@admin.register(User)
class UserAdmin(admin.ModelAdmin):
    list_display = ["email", "username", "is_active"]
    inlines = [ProfileInline]

class PostImageInline(admin.TabularInline):
    model = PostImage
    extra = 1

@admin.register(Post)
class PostAdmin(admin.ModelAdmin):
    list_display = ["id", "author", "created_at"]
    list_filter = ["created_at"]
    search_fields = ["caption", "author__email"]
    inlines = [PostImageInline]

@admin.register(Tag)
class TagAdmin(admin.ModelAdmin):
    prepopulated_fields = {"slug": ("name",)}
```

---

## 9. Testing

### File Structure
```
tests/
├── conftest.py       # Fixtures
├── factories.py      # Factory Boy
├── test_models.py
├── test_views.py
└── test_services.py
```

### Fixtures
```python
# tests/conftest.py
import pytest
from app.models import User, Post

@pytest.fixture
def user(db):
    return User.objects.create_user(
        email="test@example.com",
        username="testuser",
        password="testpass123",
    )

@pytest.fixture
def post(db, user):
    return Post.objects.create(author=user, caption="Test")

@pytest.fixture
def client_logged_in(client, user):
    client.login(email="test@example.com", password="testpass123")
    return client
```

### Test Examples
```python
# tests/test_models.py
class TestPost:
    def test_str(self, post):
        assert str(post) == f"Post #{post.pk} by testuser"
    
    def test_likes_count(self, post, user):
        assert post.likes.count() == 0
        Like.objects.create(user=user, post=post)
        assert post.likes.count() == 1

# tests/test_views.py
class TestFeed:
    def test_feed_anonymous(self, client):
        response = client.get("/")
        assert response.status_code == 200
    
    def test_create_requires_login(self, client):
        response = client.get("/post/new/")
        assert response.status_code == 302  # redirect to login
```

---

## 10. Settings

### Single settings.py with env
```python
# src/config/settings.py
import os
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent

SECRET_KEY = os.environ.get("SECRET_KEY", "dev-key")
DEBUG = os.environ.get("DEBUG", "True").lower() == "true"
ALLOWED_HOSTS = os.environ.get("ALLOWED_HOSTS", "localhost").split(",")

INSTALLED_APPS = [
    "django.contrib.admin",
    "django.contrib.auth",
    # ...
    "app",
]

AUTH_USER_MODEL = "app.User"

# Database
import dj_database_url
DATABASES = {
    "default": dj_database_url.config(
        default="postgres://localhost/djgramm"
    )
}

# Static & Media
STATIC_URL = "/static/"
MEDIA_URL = "/media/"
MEDIA_ROOT = BASE_DIR / "media"
```

---

## 11. Code Style

### Imports Order
```python
# 1. stdlib
import os
from datetime import datetime

# 2. django
from django.db import models
from django.shortcuts import render

# 3. third-party
from PIL import Image

# 4. local
from .models import Post
from .services import generate_thumbnail
```

### Formatting
- Use `ruff` (ruff.toml or pyproject.toml)
- Line length: 88 (Black style)
- Use f-strings

---

## 12. Git Commits

Format: `type: message`

- `feat:` new feature
- `fix:` bug fix
- `test:` tests
- `docs:` documentation
- `refactor:` code improvement

Examples:
```
feat: add post like functionality
fix: resolve N+1 in feed view
test: add Post model tests
```

---

## 13. Common Patterns

### get_object_or_404
```python
from django.shortcuts import get_object_or_404

post = get_object_or_404(Post, pk=pk)  # ✅
post = get_object_or_404(Post, pk=pk, author=request.user)  # with permission
```

### Messages
```python
from django.contrib import messages

messages.success(request, "Post created!")
messages.error(request, "Something went wrong")
```

### Redirect after POST
```python
from django.shortcuts import redirect

def create_post(request):
    if request.method == "POST":
        # ... save
        return redirect("post_detail", pk=post.pk)
    return render(request, "form.html")
```

---

## 14. Security Checklist

- [ ] `{% csrf_token %}` in all forms
- [ ] `LoginRequiredMixin` / `@login_required`
- [ ] `get_object_or_404()` instead of `.get()`
- [ ] Never raw SQL with user input
- [ ] `DEBUG=False` in production
- [ ] `SECRET_KEY` from environment
